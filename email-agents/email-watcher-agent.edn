{:email-watcher-agent
 {:description "Email watcher that monitors inbox and summarizes new emails with LLM using declarative loop for batch processing"
  :start :watch-loop
  :max-steps 100  ; Allow many iterations for continuous watching

  :tools
  {:watch-emails {:fn email-client.tools.registry/watch-emails}
   :write-file {:fn pyjama.tools.io/write-file}}

  :steps
  {:watch-loop
   {:tool :watch-emails
    :args {:interval-ms 5000
           :limit 10}  ; Get up to 10 emails at once
    :routes [{:when [:nonempty [:obs :emails]] :next :process-all-emails}
             {:else :watch-loop}]}  ; Keep looping

   ;; NEW: Process all emails using declarative loop
   :process-all-emails
   {:loop-over [:obs :emails]
    :loop-body :summarize-email
    :next :watch-loop}  ; After processing all emails, go back to watching

   :summarize-email
   {:prompt "New email received ({{loop-index}} of {{loop-count}}):

From: {{loop-item.from}}
Subject: {{loop-item.subject}}
Date: {{loop-item.date}}

Email content:
{{loop-item.body}}

Please provide a brief 2-3 sentence summary of this email highlighting the key points and any action items."
    :next :save-summary}

   :save-summary
   {:tool :write-file
    :args {:path "email-summaries.md"
           :content "## Email {{loop-index}} from {{loop-item.from}}
**Subject:** {{loop-item.subject}}  
**Date:** {{loop-item.date}}

**Summary:**
{{last-obs.text}}

---

"
           :append true}
    :next :done}}}}  ; Return to loop
